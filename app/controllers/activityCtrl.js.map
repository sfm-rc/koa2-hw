{"version":3,"sources":["../../src/controllers/activityCtrl.js"],"names":["list","ctx","next","params","request","body","admin_id","limit","pageIndex","sql","data","count","map","item","registrate_end_time","unix","status","limit_num","cur_num","code","message","list_search","id","title","where","where_sql","first","value","console","log","get","activity","add","link_url","image_url","start_time","end_time","location","leader_name_alias","success","points","seq","price","type","res","update"],"mappings":"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","file":"activityCtrl.js","sourcesContent":["\r\nimport {query} from '../models/db_connection';\r\nimport { pagination, getLinuxTimeStamp} from '../uitil';\r\nimport moment from 'moment';\r\n\r\n/**\r\n * 获取活动列表\r\n * @param {*} ctx \r\n * @param {*} next \r\n */\r\nconst list = async (ctx, next) => {\r\n  const params = ctx.request.body;\r\n  const {admin_id, limit, pageIndex} = params;\r\n  const sql = 'select * from hw_activity where admin_id=? ORDER BY seq desc limit ?,?';\r\n  let data = await query(sql, [admin_id, (pageIndex-1)*limit, limit]);\r\n  let count = await query('select count(*) as count from hw_activity where admin_id=?', [admin_id]);\r\n  // let join_count = await query('select count(*) as count from hw_join where activity_id=?', [data])\r\n  data = data.map(item=>{\r\n    if(item.registrate_end_time < moment().unix()){\r\n      item.status = 'time_out';\r\n    }\r\n    if(item.limit_num<=item.cur_num){\r\n      item.status = 'full';\r\n    }\r\n    return item;\r\n  });\r\n\r\n  ctx.body = Object.assign({code: 0, message: 'success', 'data': data}, pagination(limit, pageIndex, count[0].count));\r\n}\r\n\r\n/**\r\n * 获取活动列表,管理后台使用\r\n * @param {*} ctx \r\n * @param {*} next \r\n */\r\nconst list_search = async (ctx, next) => {\r\n  const params = ctx.request.body;\r\n  const {admin_id, id, title, limit, pageIndex} = params;\r\n  const where = {};\r\n\r\n  if(id){\r\n    where['id'] = id;\r\n  }\r\n  if(title){\r\n    where['title'] = title;\r\n  }\r\n  let where_sql = '';\r\n  let first = true;\r\n  for(let item in where){\r\n    const value = where[item];\r\n    if(first){\r\n      where_sql = `where ${item} like \"%${value}%\"`;\r\n      first = false;\r\n    }\r\n    else {\r\n      where_sql = `${where_sql} and ${item} like \"%${value}%\"`;\r\n    }\r\n  }\r\n  if(admin_id&&admin_id!=0){\r\n    if(first){\r\n      where_sql = `where admin_id=${admin_id}`;\r\n      first = false;\r\n    }\r\n    else {\r\n      where_sql = `${where_sql} and admin_id=${admin_id}`;\r\n    }\r\n  }\r\n\r\n\r\n  const sql = `select A.*, B.club_name from hw_activity as A join hw_admin as B on A.admin_id=B.id ${where_sql} ORDER BY seq desc limit ${(pageIndex-1)*limit},${limit}`;\r\n  console.log('list_search_sql:', sql);\r\n  let data = await query(sql);\r\n  let count = await query(`select count(*) as count from hw_activity ${where_sql}`);\r\n  // let join_count = await query('select count(*) as count from hw_join where activity_id=?', [data])\r\n  data = data.map(item=>{\r\n    if(item.registrate_end_time < moment().unix()){\r\n      item.status = 'time_out';\r\n    }\r\n    if(item.limit_num<=item.cur_num){\r\n      item.status = 'full';\r\n    }\r\n    return item;\r\n  });\r\n\r\n  ctx.body = Object.assign({code: 0, message: 'success', 'data': data}, pagination(limit, pageIndex, count[0].count));\r\n}\r\n\r\n/**\r\n * 获取详情\r\n * @param {*} ctx \r\n * @param {*} next \r\n */\r\nconst get = async(ctx, next) => {\r\n  const params = ctx.request.body;\r\n  const {id} = params;\r\n  const sql = 'select * from hw_activity where id=?';\r\n  const activity = await query(sql, [id]);\r\n  ctx.body = {code: 0, message: 'success', data: activity[0]}\r\n}\r\n\r\n/**\r\n * 添加活动 管理后台使用\r\n * @param {*} ctx \r\n * @param {*} next \r\n */\r\nconst add = async(ctx, next) => {\r\n  const params = ctx.request.body;\r\n  const {title, link_url, image_url, start_time, end_time, registrate_end_time, \r\n    cur_num, limit_num, location, leader_name_alias, success, points, seq, status, price,\r\n    admin_id, type} = params;\r\n  const sql = `INSERT INTO hw_activity VALUES (NULL, '${title}', '${link_url}', '${image_url}',\r\n              '${start_time}', '${end_time}', '${registrate_end_time}', '${cur_num}', '${limit_num}', \r\n              '${location}', '${leader_name_alias}', '${success}', '${points}', '${seq}', '${status}', \r\n              ${price}, ${admin_id}, '${type}')`;\r\n  console.log('add activity sql:', sql);\r\n  const res = await query(sql);\r\n  ctx.body = {code: 0, message: 'success', data: res}\r\n}\r\n\r\n/**\r\n * 更新活动 管理后台使用\r\n * @param {*} ctx \r\n * @param {*} next \r\n */\r\nconst update = async(ctx, next) => {\r\n  const params = ctx.request.body;\r\n  const {id, title, link_url, image_url, start_time, end_time, registrate_end_time, \r\n    cur_num, limit_num, location, leader_name_alias, success, points, seq, status, price,\r\n    admin_id, type} = params;\r\n  const sql = `update hw_activity set title='${title}', link_url='${link_url}', image_url='${image_url}',\r\n              start_time='${start_time}', end_time='${end_time}', registrate_end_time='${registrate_end_time}', cur_num='${cur_num}', limit_num='${limit_num}', \r\n              location='${location}', leader_name_alias='${leader_name_alias}', success='${success}', points='${points}', seq='${seq}', status='${status}', \r\n              price=${price}, admin_id=${admin_id}, type='${type}' where id=${id}`;\r\n  console.log('update activity sql:', sql);\r\n  const res = await query(sql);\r\n  ctx.body = {code: 0, message: 'success', data: res}\r\n}\r\n\r\n\r\nexport default {\r\n  list,\r\n  add,\r\n  update,\r\n  get,\r\n  list_search,\r\n}"]}